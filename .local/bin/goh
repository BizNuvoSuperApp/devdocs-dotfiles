#!/usr/bin/env bash

if ! which gum >/dev/null 2>&1 ; then
    winget install charmbracelet.gum
fi

if [[ ! -f $HOME/.config/bash-updates/gum.upd ]]; then
    mkdir -p $HOME/.config/bash-updates
    touch $HOME/.config/bash-updates/gum.upd
else
    before_time=$(date -d 'now - 7 day' +%s)
    last_upgrade_time=$(date -r $HOME/.config/bash-updates/gum.upd +%s)

    if (( last_upgrade_time <= before_time )); then
        echo "== Updating CLI tools =="
        winget update charmbracelet.gum
        touch $HOME/.config/bash-updates/gum.upd
    fi
fi


ssh_hosts=("Exit Quit")
foundHosts=false

while read -r ssh_host; do
    ssh_hosts+=("$ssh_host")
    foundHosts=true
done < <(awk 'tolower($1) == "host" && $2 !~ /github/ {print $2}' ~/.ssh/config)

if [[ $foundHosts != true ]]; then
    echo "No host aliases defined in config file"
    exit 1
fi

resp=$(gum filter --limit=1 --timeout=10s --header="Pick SSH host to connect to:" "${ssh_hosts[@]}")

if [[ -n $resp && $resp != 'Exit Quit' ]]; then
    ssh $resp
fi
